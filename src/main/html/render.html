<meta charset='utf-8'>
<html>
	<body>
		<div id='target'></div>
	</body>

	<script src='frp.js'></script>
	<script src='fun.js'></script>

	<script type='text/javascript'>
'use strict';

let element = (tag, attrs) => children => {
	let el = document.createElement(tag);
	for (let [key, value] of Object.entries(attrs)) el.setAttribute(key, value);
	for (let child of children) el.appendChild(child);
	return el;
};

let element_li = element('li', {});
let element_p =  element('p', {});

let rd_element = childf => elementf => (vm0, vm1, dom, domc) => {
	if (vm0 == null)
		dom.appendChild(domc = elementf([childf(vm1)]));
	else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1)
		domc.replaceChild(childf(vm1), domc.childNodes[0]);
};

let rd_dict = (keyf, elementf, rdf) => (vm0, vm1, dom, domc) => {
	if (vm0 == null) {
		dom.appendChild(domc = elementf());
		for (let i = 0; i < vm1.length; i++) rdf(null, vm1[i], domc, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1) {
		let m = new Map();
		for (let i = 0; i < vm0.length; i++) m.set(keyf(vm0[i]), i);

		let isSameOrder = true;
		let children0 = [];
		let indices0 = [];

		for (let i = 0; i < vm1.length; i++) {
			var i0 = m.get(keyf(vm1[i]));
			isSameOrder &= i0 == i;
			children0.push(domc.childNodes[i0]);
			indices0.push(i0);
		}

		if (isSameOrder)
			for (let i = 0; i < vm1.length; i++)
				rdf(vm0[i], vm1[i], domc, children0[i]);
		else {
			let domc1 = domc.cloneNode(false);
			for (let i = 0; i < vm1.length; i++) {
				let i0 = indices0[i];
				if (i0 != null) {
					let child0 = children0[i];
					domc1.appendChild(child0);
					rdf(vm0[i0], vm1[i], domc1, child0);
				} else
					rdf(null, vm1[i], domc1, null);
			}
			dom.replaceChild(domc1, domc);
		}
	}
};

let rd_vector = (vm0, vm1, dom, domc) => {
	if (vm0 == null) {
		dom.appendChild(domc = document.createElement('ul'));
		for (let i = 0; i < vm1.length; i++) rd_listItem(null, vm1[i], domc, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1) {
		let i = 0;
		let children = domc.childNodes;
		let imin = Math.min(vm0.length, vm1.length);
		for (; i < imin; i++) rd_listItem(vm0[i], vm1[i], domc, children[i]);
		for (; i < vm1.length; i++) rd_listItem(null, vm1[i], domc, null);
		for (; i < children.length; i++) domc.removeChild(children[i]);
	}
};

let rd_elementText = rd_element(t => document.createTextNode(t));
let rd_text = rd_elementText(element_p);
let rd_listItem = rd_elementText(element_li);
let rd_fruits = rd_dict(vm => vm, () => document.createElement('ul'), rd_listItem);

let rd_vm = (vm0, vm1, dom) => {
	if (vm0 == null) {
		rd_text(null, vm1.message, dom, null);
		rd_fruits(null, vm1.fruits, dom, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1) {
		let [dom0, dom1] = dom.childNodes;
		rd_text(vm0.message, vm1.message, dom, dom0);
		rd_fruits(vm0.fruits, vm1.fruits, dom, dom1);
	}
	return dom;
};

let pvm = null;

let renderAgain = vm => {
	rd_vm(pvm, vm, document.getElementById('target'));
	pvm = vm;
};

renderAgain({ message: 'hello world0', fruits: [], });
renderAgain({ message: 'hello world1', fruits: ['apple',], });
renderAgain({ message: 'hello world2', fruits: ['apple', 'orange',], });
renderAgain({ message: 'hello world~', fruits: ['orange',], });
	</script>

</html>
