<meta charset="utf-8">
<html>

	<body>
		<canvas id="canvas" width="800" height="600" style="z-index:1; border:1px solid #000000">
			<!-- style="position:fixed; left:10px; top:10px;" -->
			Your browser does not support HTML5 Canvas.
		</canvas>
		
		<textarea id="log" rows="10" cols="132">
			== START ==
		</textarea>
		
		<script type="text/javascript">
			var log = function(m) {
				var text = document.getElementById("log").value + m + "\n";
				if (text.length > 256) text = text.substring(text.length - 256, text.length);
				document.getElementById("log").value = text;
				// alert(m);
			};
			
			var tokeycode = function(e) {
				return (!(e.which)) ? e.keyCode : (e.which ? e.which : 0);
			};
			
			var canvas = document.getElementById("canvas");
			var width = canvas.width, height = canvas.height;

			var canvas0 = document.createElement("canvas"); // off-screen buffer
			canvas0.width = width;
			canvas0.height = height;
			
			var context = canvas.getContext("2d");
			var context0 = canvas0.getContext("2d");
			
			var ballx = width / 2, bally = height / 2;
			var dx = 2, dy = 2;
			
			var pressed = {};
			
			var input = function() {
				var dx = 0, dy = 0;
				if (pressed[37]) dx = -1;
				else if (pressed[38]) dy = -1;
				else if (pressed[39]) dx = 1;
				else if (pressed[40]) dy = 1;
				
				ballx += 2 * dx;
				bally += 2 * dy;
			};
			
			var move = function() {
				ballx += dx;
				bally += dy;
				
				if (ballx < 0) { ballx = 0; dx = 2; }
				if (bally < 0) { bally = 0; dy = 2; }
				if (ballx > width) { ballx = width; dx = -2; }
				if (bally > height) { bally = height; dy = -2; }
			};
			
			var repaint = function() {
				context0.fillStyle = "#777777";
				context0.fillRect(0, 0, width, height);
				
				context0.fillStyle = "#000000";
				context0.moveTo(0, 0);
				context0.lineTo(width, height);
				context0.stroke();
				
				context0.font = "30px Helvetica";
				context0.strokeText("Demo", 16, height - 16);
				
				context0.beginPath();
				context0.arc(ballx, bally, 8, 0, 2 * Math.PI);
				context0.stroke();
				
				context.drawImage(canvas0, 0, 0);
			};
			
			var tick = function() {
				input();
				move();				
				repaint();
				setTimeout(tick, 25);
			};
			
			document.onkeydown = function(e) {
				log("onkeydown = " + tokeycode(e) + "/" + String.fromCharCode(e));
				pressed[tokeycode(e)] = true;
			};
			document.onkeyup = function(e) {
				pressed[tokeycode(e)] = false;
			};
			
			document.onmousemove = function(e) {
				var e1 = (!e) ? window.event : e;
				if (e1.pageX || e1.pageY) {
					x = e1.pageX;
					y = e1.pageY;
				} else if (e1.clientX || e1.clientY) {
					x = e1.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
					y = e1.clientY + document.body.scrollTop + document.documentElement.scrollTop;
				}
				log("onmousemove = " + x + ", " + y);
			};
			document.onmousedown = function(e) {
			};
			
			tick();
		</script>
	</body>

</html>
