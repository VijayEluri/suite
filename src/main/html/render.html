<meta charset='utf-8'>
<html>
	<body>
		<div id='target'></div>
	</body>

	<script src='frp.js'></script>
	<script src='fun.js'></script>

	<script type='text/javascript'>
'use strict';

let element = (tag, attrs, children) => {
	let el = document.createElement(tag);
	for (let [key, value] of Object.entries(attrs)) el.setAttribute(key, value);
	for (let child of children) el.appendChild(child);
	return el;
};

let element_li = children => element('li', {}, children);
let element_p = children => element('p', {}, children);

let rd_text = (vm0, vm1) => dom => {
	 if (vm0 == null)
	 	dom = element_p([document.createTextNode(vm1)]);
	 else if (vm0 != vm1)
	 	dom.replaceChild(document.createTextNode(vm1), dom.childNodes[0]);
	 return dom;
};

let rd_listItem = (vm0, vm1) => dom => {
	 if (vm0 == null)
	 	dom = element_li([document.createTextNode(vm1)]);
	 else if (vm0 != vm1)
	 	dom.replaceChild(document.createTextNode(vm1), dom.childNodes[0]);
	 return dom;
};

let rd_fruits = (vm0, vm1) => dom => {
	 if (vm0 == null) {
	 	dom = document.createElement('ul');
	 	for (let i = 0; i < vm1.length; i++) dom.appendChild(listItem(null, vm1[i])(null));
	 } else if (vm0 != vm1) {
	 	let i = 0;
	 	let children = dom.childNodes;
	 	let imin = Math.min(vm0.length, vm1.length);
	 	for (; i < imin; i++) dom.replaceChild(rd_listItem(vm0[i], vm1[i])(children[i]), children[i]);
	 	for (; i < vm1.length; i++) dom.appendChild(rd_listItem(null, vm1[i])(null));
	 	for (; i < children.length; i++) dom.removeChild(children[children.length - 1]);
	 }
	 return dom;
};

let rd_vm = (vm0, vm1) => dom => {
	if (vm0 == null) {
		dom.appendChild(rd_text(null, vm1.message)(null));
		dom.appendChild(rd_fruits(null, vm1.fruits)(null));
	} else if (vm0 != vm1) {
		let [dom0, dom1] = dom.childNodes;
		dom.replaceChild(rd_text(vm0.message, vm1.message)(dom0), dom0);
		dom.replaceChild(rd_fruits(vm0.fruits, vm1.fruits)(dom1), dom1);
	}
	return dom;
};

let pvm = null;

let renderAgain = vm => {
	rd_vm(pvm, vm)(document.getElementById('target'));
	pvm = vm;
};

renderAgain({ message: 'hello world0', fruits: [], });
renderAgain({ message: 'hello world1', fruits: ['apple',], });
renderAgain({ message: 'hello world2', fruits: ['apple', 'orange',], });
renderAgain({ message: 'hello world~', fruits: ['orange',], });
	</script>

</html>
