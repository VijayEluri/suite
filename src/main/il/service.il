constant svc-halt_ = 0;
constant svc-nl___ = 1;
constant svc-putc_ = 2;
constant svc-ticks = 3;

declare svc-handle-service = function [p0, p1, p2,] (
	if (p0 = svc-halt_) then (
		sync-yield [];
	) else if (p0 = svc-nl___) then (
		cs-nl [];
	) else if (p0 = svc-putc_) then (
		if (p1 != 10) then (cs-put [p1,]) else (cs-nl []);
	) else if (p0 = svc-ticks) then (
		ticks;
	) else ();
);

declare sysenter-sink = [p0, p1, p2,] (
	asm _ PUSH (EDI); -- Return IP
	asm _ PUSH (EDX); -- Return ESP
	asm _ PUSH (EAX); -- p0
	asm _ PUSH (EBX); -- p1
	asm _ PUSH (ECX); -- p2
	asm _ MOV (AX, +x10);
	asm _ MOV (DS, AX);
	asm _ PUSH (0);
	asm _ PUSH (`+x40000`);
	asm _ MOV (EBP, ESP);

	svc-handle-service [p0, p1, p2,];

	asm _ MOV (ESP, EBP);
	asm _ ADD (ESP, 20);
	asm _ MOV (DX, +x23);
	asm _ MOV (DS, DX);
	asm _ POP (ECX);
	asm _ POP (EDX);
	asm _ POP (EBP);
	asm _ SYSEXIT ();
);

declare svc-service = function [p0, p1, p2,] (
	declare cs0;
	asm _ ADD (ESP, 4);
	asm _ PUSH (CS);

	if (cs0 and 3 != 0) then (
		asm _ MOV (EAX, `EBP + 16`);
		asm _ MOV (EBX, `EBP + 12`);
		asm _ MOV (ECX, `EBP + 8`);
		asm _ MOV (EDX, ESP);
		asm _ D8 (+x68);
		asm _ D32 (.sysexitPoint);
		asm _ POP (EDI);
		asm _ SYSENTER ();
		asm .sysexitPoint ();
	) else (
		svc-handle-service [p0, p1, p2,];
	);
);

declare svc-setup = function [] (
	wrmsr [+x174, +x8,];
	wrmsr [+x175, syscall-stack-address,];
	wrmsr [+x176, sysenter-sink as int,];
);
