<meta charset="utf-8">
<html style="width: 100%; height: 100%; margin: 0px;">

	<body style="width: 100%; height: 100%; margin: 0px;">
		<canvas id="canvas" style="z-index:1; border:1px solid #000000">
			<!-- style="position:fixed; left:10px; top:10px;" -->
			Your browser does not support HTML5 canvas.
		</canvas>
	</body>

	<script src="frp.js"></script>
	<script src="fun.js"></script>

	<script type="text/javascript">
		"use strict";

		var width = window.innerWidth;
		var height = window.innerHeight;

		var canvas = document.getElementById("canvas");
		canvas.width = width;
		canvas.height = height;

		var frame = frp.animframe();
		var fx = frp.kb.arrowx.resample(frame).last();
		var fy = frp.kb.arrowy.resample(frame).last();

		var background = {
			move: () => [background],
			draw: context => {
				context.fillStyle = "#777777";
				context.fillRect(0, 0, width, height);

				context.fillStyle = "#000000";
				context.font = "10px Helvetica";
				context.fillText("Demo", 16, height - 16);
			},
		};

		var ball_ = function(ballx, bally) {
			var dx = 2, dy = 2;

			var ball = {
				move: () => {
					var ix = fx();
					var iy = fy();
					if (ix) ballx += 2 * ix;
					if (iy) bally += 2 * iy;
					ballx += dx;
					bally += dy;

					if (ballx < 0) { ballx = 0; dx = 2; }
					if (bally < 0) { bally = 0; dy = 2; }
					if (width < ballx) { ballx = width; dx = -2; }
					if (height < bally) { bally = height; dy = -2; }
					return [ball];
				},
				draw: context => {
					var radius = 24;

					/* context.beginPath(); context.arc(ballx, bally, radius, 0, 2 * Math.PI); context.stroke(); */

					context.fillStyle = "#0000FF";
					context.beginPath();
					context.moveTo(ballx, bally - radius);
					context.lineTo(ballx + radius * 0.866, bally - radius * 0.5);
					context.lineTo(ballx + radius * 0.866, bally + radius * 0.5);
					context.lineTo(ballx, bally + radius);
					context.lineTo(ballx - radius * 0.866, bally + radius * 0.5);
					context.lineTo(ballx - radius * 0.866, bally - radius * 0.5);
					context.closePath();
					context.fill();
				},
			};

			return ball;
		};

		var ballx0 = Math.floor(width * Math.random());
		var bally0 = Math.floor(height * Math.random());
		var objects = [background, ball_(ballx0, bally0)];

		var clicks = frp.mouse.move
			.resample(frp.mouse.click.filter(mb => mb))
			.map(xy => { return { x: xy.x - canvas.offsetLeft, y: xy.y - canvas.offsetTop, }; })
			.read();

		frame.register(data => {

			// move
			objects = read(objects)
				.map(object => object.move())
				.concat()
				.append(clicks().map(xy => ball_(xy.x, xy.y)))
				.list();

			// repaint
			var context = canvas.getContext("2d");
			read(objects).foreach(object => object.draw(context));
		});

		frp.mouse.move.register(d => console.log("mouse " + d.x + "," + d.y));
	</script>

</html>
