<meta charset="utf-8">
<html>

	<body>
		<canvas id="canvas" width="800" height="600" style="z-index:1; border:1px solid #000000">
			<!-- style="position:fixed; left:10px; top:10px;" -->
			Your browser does not support HTML5 canvas.
		</canvas>

		<textarea id="log" rows="10" cols="80">
			== START ==
		</textarea>
	</body>

	<script src="frp.js"></script>
	<script src="fun.js"></script>
	<script src="controller.js"></script>

	<script type="text/javascript">
		"use strict";

		var canvas = document.getElementById("canvas");

		var frame = frpanimframe();
		var fx = frpkbarrowx.resample(frame).last();
		var fy = frpkbarrowy.resample(frame).last();

		var width = canvas.width;
		var height = canvas.height;
		var objects = [];

		var ballx = Math.floor(width * Math.random()), bally = Math.floor(height * Math.random());
		var dx = 2, dy = 2;

		var ball = {
			move: function() {
				var ix = fx();
				var iy = fy();
				if (typeof ix != 'undefined') ballx += 2 * fx();
				if (typeof iy != 'undefined') bally += 2 * fy();
				ballx += dx;
				bally += dy;

				if (ballx < 0) { ballx = 0; dx = 2; }
				if (bally < 0) { bally = 0; dy = 2; }
				if (ballx > width) { ballx = width; dx = -2; }
				if (bally > height) { bally = height; dy = -2; }
				return [this];
			}
			, draw: function(context) {
				var radius = 24;
				context.beginPath();
				context.arc(ballx, bally, radius, 0, 2 * Math.PI);
				context.stroke();
			}
		};

		var objects = [ball];

		frpmousemove.register(function(d) { log("mouse " + d.x + "," + d.y); });

		frame.register(function(data) {

			// move
			objects = read(objects)
				.map(function(object) { return object.move(); })
				.concat()
				.list();

			// repaint
			var context = canvas.getContext("2d");
			context.fillStyle = "#777777";
			context.fillRect(0, 0, width, height);

			context.fillStyle = "#000000";
			context.font = "10px Helvetica";
			context.fillText("Demo", 16, height - 16);

			read(objects).foreach(function(object) { object.draw(context); });
		});
	</script>

</html>
