<meta charset="utf-8">
<html>

	<body>
		<canvas id="canvas" width="800" height="600" style="z-index:1; border:1px solid #000000">
			<!-- style="position:fixed; left:10px; top:10px;" -->
			Your browser does not support HTML5 Canvas.
		</canvas>
		
		<textarea id="log" rows="5" cols="80">
			== START ==
		</textarea>
	</body>
	
	<script src="fun.js"></script>
	
	<script type="text/javascript">
		var map = function(fun, ins) {
			var outs = [];
			for (var i = 0; i < ins.length; i++) outs.push(fun(ins[i]));
			return outs;
		};
		
		var filter = function(fun, ins) {
			var outs = [];
			for (var i = 0; i < ins.length; i++) {
				object = ins[i];
				if (fun(object)) outs.push(object);
			}
			return outs;
		};
		
 		var concat = function(ins) {
			var out = [];
			for (var i = 0; i < ins.length; i++) {
				child = ins[i];
				for (var j = 0; j < child.length; j++)
					outs.push(child[j]);
			}
			return outs;
		};
		
 		var fold = function(fun, value, ins) {
			for (var i = 0; i < ins.length; i++)
				value = fun(value, ins[i]);
			return value;
		};
		
		var log = function(m) {
			var text = document.getElementById("log").value + m + "\n";
			if (text.length > 256) text = text.substring(text.length - 256, text.length);
			document.getElementById("log").value = text;
			// alert(m);
		};
		
		var canvas = document.getElementById("canvas");

		var keyboard = function(document) {
			var tokeycode = function(e) { return (!(e.which)) ? e.keyCode : (e.which ? e.which : 0); };		
			
			var pressed = {};
			document.onkeydown = function(e) { pressed[tokeycode(e)] = true; };
			document.onkeyup = function(e) { pressed[tokeycode(e)] = false; };
			
			// log("onkeydown = " + tokeycode(e) + "/" + String.fromCharCode(tokeycode(e)));
			
			return {
				dirx: function() { return pressed[37] ? -1 : (pressed[39] ? 1 : 0); }
				, diry: function() { return pressed[38] ? -1 : (pressed[40] ? 1 : 0); }
				, paused: function() { return pressed[80]; }
			};
		}(document);
		
		var mouse = function(document) {
			var x, y;
			var down;
			
			document.onmousemove = function(e) {
				var e1 = (!e) ? window.event : e;
				if (e1.pageX || e1.pageY) {
					x = e1.pageX;
					y = e1.pageY;
				} else if (e1.clientX || e1.clientY) {
					x = e1.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
					y = e1.clientY + document.body.scrollTop + document.documentElement.scrollTop;
				}
				log("onmousemove = " + x + ", " + y);
			};
			document.onmousedown = function(e) { down = true; };
			document.onmouseup = function(e) { up = true; };
		}(document);
		
		var ball = function(width, height) {
			var ballx = width / 2, bally = height / 2;
			var dx = 2, dy = 2;
			
			return {
				input: function(keyboard) {
					ballx += 2 * keyboard.dirx();
					bally += 2 * keyboard.diry();
				}				
				, move: function() {
					ballx += dx;
					bally += dy;
					
					if (ballx < 0) { ballx = 0; dx = 2; }
					if (bally < 0) { bally = 0; dy = 2; }
					if (ballx > width) { ballx = width; dx = -2; }
					if (bally > height) { bally = height; dy = -2; }
				}
				, alive: function() {
					return true;
				}
				, draw: function(context) {
					var radius = 8;
					
					context.fillStyle = "#000000";
					context.moveTo(ballx - radius, bally);
					context.lineTo(ballx + radius, bally);
					context.moveTo(ballx, bally - radius);
					context.lineTo(ballx, bally + radius);
					context.stroke();
					
					context.beginPath();
					context.arc(ballx, bally, radius, 0, 2 * Math.PI);
					context.stroke();
				}
			};
		}(canvas.width, canvas.height);
		
		var controller = function(canvas, keyboard, mouse) {					
			var width = canvas.width, height = canvas.height;
			
			var canvas0 = document.createElement("canvas"); // off-screen buffer
			canvas0.width = width;
			canvas0.height = height;
			
			var context = canvas.getContext("2d");
			var context0 = canvas0.getContext("2d");
			
			repaint = function(context, objects) {
				context.fillStyle = "#777777";
				context.fillRect(0, 0, width, height);
				
				context.fillStyle = "#000000";
				context.font = "10px Helvetica";
				context.fillText("Demo", 16, height - 16);
				
				map(function(object) { object.draw(context); }, objects);
			};
			
			return {
				tick: function() {
					var objects = [ball];
					
					if (!keyboard.paused()) {
						map(function(object) {
							object.input(keyboard);
							object.move();
						}, objects);
						
						objects = filter(function(object) { return object.alive(); }, objects);
						
						repaint(context0, objects);
						context.drawImage(canvas0, 0, 0);
					}
				}
			};
		}(canvas, keyboard, mouse);
		
		var tick = function() {
			controller.tick();
			setTimeout(tick, 25);
		};
		
		tick();
	</script>
	
</html>
