<meta charset='utf-8'>
<html>
	<body>
		<div id='target'></div>
	</body>

	<script src='frp.js'></script>
	<script src='fun.js'></script>

	<script type='text/javascript'>
'use strict';

let newElement = (tag, attrs, children) => {
	let el = document.createElement(tag);
	if (attrs != null)
		for (let [key, value] of Object.entries(attrs))
			el.setAttribute(key, value);
	if (children != null)
		for (let child of children)
			el.appendChild(child);
	return el;
};

let rd_c = elementf => (vm0, vm1, dom, domc) => {
	if (vm0 != vm1) {
		if (vm0 != null) dom.removeChild(domc);
		if (vm1 != null) dom.appendChild(elementf(vm1), domc);
	}
};

let rd_prop = (key, rdf) => (vm0, vm1, dom, domc) => {
	rdf(
		vm0 != null ? vm0[key] : null,
		vm1 != null ? vm1[key] : null,
		dom, domc);
};

let rd_element = (elementf, childrenf) => (vm0, vm1, dom, domc) => {
	if (vm0 == null) {
		dom.appendChild(domc = elementf());
		for (let childf of childrenf)
			childf(null, vm1, domc, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1)
		for (let i = 0; i < childrenf.length; i++)
			childrenf[i](vm0, vm1, domc, domc.childNodes[i]);
};

let rd_for = (keyf, elementf, rdf) => (vm0, vm1, dom, domc) => {
	if (vm0 == null) {
		dom.appendChild(domc = elementf());
		for (let i = 0; i < vm1.length; i++) rdf(null, vm1[i], domc, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1) {
		let m = new Map();
		for (let i = 0; i < vm0.length; i++) m.set(keyf(vm0[i]), i);

		let isSameOrder = true;
		let children0 = [];
		let indices0 = [];

		for (let i = 0; i < vm1.length; i++) {
			var i0 = m.get(keyf(vm1[i]));
			isSameOrder &= i0 == i;
			children0.push(domc.childNodes[i0]);
			indices0.push(i0);
		}

		if (isSameOrder)
			for (let i = 0; i < vm1.length; i++)
				rdf(vm0[i], vm1[i], domc, children0[i]);
		else {
			let domc1 = domc.cloneNode(false);
			for (let i = 0; i < vm1.length; i++) {
				let i0 = indices0[i];
				if (i0 != null) {
					let child0 = children0[i];
					domc1.appendChild(child0);
					rdf(vm0[i0], vm1[i], domc1, child0);
				} else
					rdf(null, vm1[i], domc1, null);
			}
			dom.replaceChild(domc1, domc);
		}
	}
};

let rd_vector = (vm0, vm1, dom, domc) => {
	if (vm0 == null) {
		dom.appendChild(domc = newElement('ul'));
		for (let i = 0; i < vm1.length; i++) rd_listItem(null, vm1[i], domc, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1) {
		let i = 0;
		let children = domc.childNodes;
		let imin = Math.min(vm0.length, vm1.length);
		for (; i < imin; i++) rd_listItem(vm0[i], vm1[i], domc, children[i]);
		for (; i < vm1.length; i++) rd_listItem(null, vm1[i], domc, null);
		for (; i < children.length; i++) domc.removeChild(children[i]);
	}
};

let rd_textNode = rd_c(vm => document.createTextNode(vm));
let rd_listItem = rd_element(() => newElement('li'), [rd_textNode]);
let rd_text = rd_element(() => newElement('p'), [rd_textNode]);
let rd_fruits = rd_for(vm => vm, () => newElement('ul'), rd_listItem);

let rd_vm = (vm0, vm1, dom) => {
	if (vm0 == null) {
		rd_prop('message', rd_text)(null, vm1, dom, null);
		rd_prop('fruits', rd_fruits)(null, vm1, dom, null);
	} else if (vm1 == null)
		dom.removeChild(domc);
	else if (vm0 != vm1) {
		let [dom0, dom1] = dom.childNodes;
		rd_prop('message', rd_text)(vm0, vm1, dom, dom0);
		rd_prop('fruits', rd_fruits)(vm0, vm1, dom, dom1);
	}
	return dom;
};

let pvm = null;

let renderAgain = vm => {
	rd_vm(pvm, vm, document.getElementById('target'));
	pvm = vm;
};

renderAgain({ message: 'hello world0', fruits: [], });
renderAgain({ message: 'hello world1', fruits: ['apple',], });
renderAgain({ message: 'hello world2', fruits: ['apple', 'orange',], });
renderAgain({ message: 'hello world~', fruits: ['orange',], });
	</script>

</html>
